<!DOCTYPE html>
<html>
<head>
    <title>網頁版員工打卡系統</title>
    <meta charset="UTF-8">
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>員工打卡系統</h1>
    <p>請開啟您的位置功能，並點擊打卡按鈕。</p>

    <div id="map"></div>

    <p id="distanceInfo"></p>
    
    <button id="checkInBtn" onclick="sendCheckIn()" disabled>打卡</button>
    
    <p id="message"></p>

    <script>
        const companyLocation = { lat: 24.086390, lng: 120.540700 }; // 公司的緯經度 (範例地點：彰化市區)
        const checkInRadius = 200; // 打卡半徑 (公尺)
        let map, companyMarker, userMarker;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: companyLocation,
                zoom: 15,
            });

            // 標示公司位置
            companyMarker = new google.maps.Marker({
                position: companyLocation,
                map: map,
                title: '公司位置',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                }
            });

            // 取得使用者位置
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(showPosition, showError, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            } else {
                document.getElementById('message').innerText = "您的瀏覽器不支援地理位置功能。";
            }
        }

        function showPosition(position) {
            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            // 如果已有標記，先移除舊的
            if (userMarker) {
                userMarker.setMap(null);
            }
            // 標示使用者位置
            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: '您的位置'
            });

            const distance = getDistance(companyLocation, userLocation);
            document.getElementById('distanceInfo').innerText = `您距離公司 ${distance.toFixed(2)} 公尺。`;
            
            // 判斷是否在打卡範圍內
            if (distance <= checkInRadius) {
                document.getElementById('checkInBtn').disabled = false;
                document.getElementById('message').innerText = "您已在打卡範圍內，可以打卡。";
            } else {
                document.getElementById('checkInBtn').disabled = true;
                document.getElementById('message').innerText = "您不在打卡範圍內，無法打卡。";
            }
        }

        function showError(error) {
            document.getElementById('message').innerText = "無法取得您的位置資訊。請檢查瀏覽器設定。";
            console.error(error);
        }

        function getDistance(loc1, loc2) {
            // 海倫公式計算兩點距離 (公尺)
            const R = 6371e3; // 地球半徑 (公尺)
            const lat1 = loc1.lat * Math.PI / 180;
            const lat2 = loc2.lat * Math.PI / 180;
            const deltaLat = (loc2.lat - loc1.lat) * Math.PI / 180;
            const deltaLng = (loc2.lng - loc1.lng) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                      Math.cos(lat1) * Math.cos(lat2) *
                      Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function sendCheckIn() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    const distance = getDistance(companyLocation, userLocation);
                    if (distance > checkInRadius) {
                        alert('您已超出打卡範圍，無法打卡。');
                        return;
                    }

                    // 準備資料並使用 AJAX 傳送給後端
                    const data = new FormData();
                    data.append('latitude', userLocation.lat);
                    data.append('longitude', userLocation.lng);
                    data.append('employee_id', 'E001'); // 假設這是員工ID

                    fetch('checkin.php', {
                        method: 'POST',
                        body: data
                    })
                    .then(response => response.text())
                    .then(result => {
                        alert(result);
                        document.getElementById('checkInBtn').disabled = true;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('打卡失敗，請稍後再試。');
                    });
                }, showError);
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDPzIXAGgmCInKLlZKGhSH2DMfdo-iDJtQ&callback=initMap" async defer></script>
</div>

</body>
</html>